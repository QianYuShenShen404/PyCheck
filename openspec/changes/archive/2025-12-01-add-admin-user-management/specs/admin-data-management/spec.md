## MODIFIED Requirements
### Requirement: 数据清理管理
The system MUST be able to
系统必须允许管理员配置和执行基于可配置保留策略的数据清理操作，用于报告、提交和相似度数据。

#### Scenario: 管理员配置保留策略
- **GIVEN** 管理员已登录
- **WHEN** 管理员导航到数据管理 → 保留设置
- **AND** 管理员修改报告、提交和相似度的保留天数
- **THEN** 系统将设置保存到 admin_settings 表
- **AND** 系统验证值在可接受范围内（1-365 天）
- **AND** 系统在审计日志中记录配置变更
- **AND** 新设置应用于未来的清理操作

#### Scenario: 管理员手动触发数据清理
- **GIVEN** 管理员在数据管理屏幕上
- **WHEN** 管理员点击"清理旧数据"按钮
- **AND** 管理员查看清理预览（显示要删除的数据计数）
- **AND** 管理员确认操作
- **THEN** 系统删除所有超过配置保留期的数据
- **AND** 系统显示实时进度（已完成 X 项，共 Y 项）
- **AND** 系统在审计日志中记录清理操作和项目计数
- **AND** 系统在清理后更新存储统计

#### Scenario: 管理员预览清理影响
- **GIVEN** 管理员在数据管理屏幕上
- **WHEN** 管理员在执行前点击"预览清理"
- **THEN** 系统显示要删除的数据细分：
  - 旧报告数量（> 保留期）
  - 旧提交数量（> 保留期）
  - 旧相似度记录数量（> 保留期）
  - 要释放的估计存储空间
- **AND** 系统在预览模式下不删除数据
- **AND** 当保留设置改变时预览会更新

#### Scenario: 管理员查看存储统计
- **GIVEN** 管理员在数据管理屏幕上
- **WHEN** 管理员查看存储统计部分
- **THEN** 系统显示：
  - 提交、报告、相似度记录的总数
  - 估计的数据库总大小（MB）
  - 最早的提交日期
  - 最早的报告日期
  - 按年龄分组的数据分布（最近 30 天、31-90 天、>90 天）
- **AND** 当数据改变时统计自动刷新

#### Scenario: 管理员重建数据库
- **GIVEN** 管理员在数据管理 → 高级操作
- **WHEN** 管理员点击"重建数据库"按钮
- **AND** 管理员通过输入确认来确认破坏性操作
- **THEN** 系统将当前数据库备份到文件
- **AND** 系统删除并使用当前模式重新创建所有表
- **AND** 系统在重建操作期间显示进度
- **AND** 系统在完成时显示成功消息
- **AND** 系统在审计日志中记录重建操作
- **AND** 重建后所有数据丢失（用户必须重新注册）

### Requirement: 数据导出
The system MUST be able to
系统必须允许管理员将所有应用程序数据（用户、作业、提交、报告、相似度）导出为 JSON 或 CSV 格式。

#### Scenario: 管理员导出所有数据
- **GIVEN** 管理员在数据管理 → 导出数据
- **WHEN** 管理员选择要导出的数据类型（用户、作业、提交、报告、相似度）
- **AND** 管理员选择格式（JSON 或 CSV）
- **AND** 管理员点击"导出"按钮
- **THEN** 系统为选定的数据类型生成导出文件
- **AND** 系统将文件保存到 Downloads 目录
- **AND** 系统在导出期间显示进度指示器
- **AND** 系统创建带时间戳的文件名（例如 codechecker_export_2025-11-30_users.json）
- **AND** 系统在审计日志中记录导出操作

#### Scenario: 管理员导出特定数据类型
- **GIVEN** 管理员只想导出用户数据
- **WHEN** 管理员仅选择"用户"复选框并点击导出
- **THEN** 系统仅将用户表导出为 JSON
- **AND** 系统包含所有用户字段（id, username, display_name, role, status, is_active, created_at）
- **AND** 默认情况下导出中不包括密码哈希
- **AND** 系统在审计日志中记录导出操作

#### Scenario: 管理员导出时过滤
- **GIVEN** 管理员需要导出数据的特定子集
- **WHEN** 管理员设置过滤器（例如，某个日期后创建的作业、具有特定角色的用户）
- **AND** 管理员点击导出
- **THEN** 系统仅导出匹配过滤器的数据
- **AND** 导出文件仅包含过滤后的记录
- **AND** 系统在导出文件元数据中包含过滤条件

### Requirement: 数据导入
The system MUST be able to
系统必须允许管理员从 JSON 或 CSV 文件导入数据，以快速填充数据库。

#### Scenario: 管理员从 CSV 导入用户数据
- **GIVEN** 管理员有包含用户数据的 CSV 文件
- **WHEN** 管理员选择 CSV 文件并点击"导入用户"
- **AND** 系统验证 CSV 格式和必需的列
- **THEN** 系统解析 CSV 并验证每一行
- **AND** 系统为有效行创建用户（用户名唯一性要求）
- **AND** 系统跳过无效行并记录错误
- **AND** 系统显示导入进度（已处理 X 行，共 Y 行）
- **AND** 系统显示摘要：创建了 X 个用户，跳过了 Y 行，Z 个错误
- **AND** 系统在审计日志中记录导入操作

#### Scenario: 管理员导入作业配置
- **GIVEN** 管理员有包含作业模板的 JSON 文件
- **WHEN** 管理员选择 JSON 文件并点击"导入作业"
- **THEN** 系统验证 JSON 结构
- **AND** 系统基于模板创建作业
- **AND** 系统将创建者设为导入管理员
- **AND** 系统在审计日志中记录导入操作

#### Scenario: 管理员导入时解决冲突
- **GIVEN** 管理员导入可能包含重复项的数据
- **WHEN** 系统在导入期间检测到用户名冲突
- **THEN** 系统提示管理员选择：跳过重复项、更新现有或取消
- **AND** 系统一致地应用选择的策略
- **AND** 系统在审计日志中记录冲突解决决策

### Requirement: 批量报告管理
The system MUST be able to
系统必须允许管理员批量删除或归档旧报告以管理存储空间。

#### Scenario: 管理员批量删除旧报告
- **GIVEN** 管理员在数据管理 → 报告管理
- **WHEN** 管理员选择某个日期阈值之前的报告
- **AND** 管理员点击"删除选中"并确认
- **THEN** 系统永久删除选定的报告和相关的相似度记录
- **AND** 系统显示进度指示器
- **AND** 系统在审计日志中记录每次删除
- **AND** 系统更新存储统计

#### Scenario: 管理员批量归档报告
- **GIVEN** 管理员想保留报告但标记为已归档
- **WHEN** 管理员选择报告并点击"归档"
- **THEN** 系统用已归档标志标记报告
- **AND** 已归档报告在常规视图中隐藏
- **AND** 管理员可以在单独部分查看已归档报告
- **AND** 系统在审计日志中记录归档操作

#### Scenario: 管理员恢复已归档报告
- **GIVEN** 管理员查看已归档报告列表
- **WHEN** 管理员选择已归档报告并点击"恢复"
- **THEN** 系统从报告中删除已归档标志
- **AND** 报告在常规视图中再次可见
- **AND** 系统在审计日志中记录恢复操作

### Requirement: 数据库迁移安全性
The system MUST be able to
系统必须在执行模式更改之前提供迁移前检查和备份功能。

#### Scenario: 管理员在迁移前检查数据库
- **GIVEN** 系统有待处理的数据库迁移
- **WHEN** 管理员点击"迁移前检查"
- **THEN** 系统验证：
  - 可用磁盘空间（> 当前数据库大小的 2 倍）
  - 数据库完整性（无损坏）
  - 数据一致性（外键关系有效）
  - 备份存在或可以创建
- **AND** 系统显示检查结果
- **AND** 系统仅在所有检查通过时才允许迁移
- **AND** 系统在审计日志中记录迁移前检查

#### Scenario: 管理员创建数据库备份
- **GIVEN** 管理员在数据管理 → 备份/恢复
- **WHEN** 管理员点击"创建备份"
- **THEN** 系统在应用特定目录中创建带时间戳的备份文件
- **AND** 备份包含所有表和模式版本
- **AND** 系统压缩备份以节省空间
- **AND** 系统显示备份进度
- **AND** 系统在审计日志中记录备份创建
- **AND** 备份文件名：codechecker_backup_YYYY-MM-DD_HH-mm-ss.db

#### Scenario: 管理员从备份恢复
- **GIVEN** 管理员有数据库备份文件
- **WHEN** 管理员选择备份文件并点击"恢复"
- **AND** 管理员确认破坏性操作
- **THEN** 系统从备份文件恢复数据库
- **AND** 所有数据都被备份数据替换
- **AND** 系统在恢复期间显示进度
- **AND** 系统在审计日志中记录恢复操作
- **AND** 恢复完成后用户必须重启应用

## ADDED Requirements
### Requirement: 数据清理调度
The system MUST be able to
系统必须支持可选的调度数据清理用于自动维护。

#### Scenario: 管理员启用自动清理
- **GIVEN** 管理员正在配置保留策略
- **WHEN** 管理员切换"启用自动清理"选项
- **AND** 管理员设置计划（每日、每周、每月）
- **THEN** 系统将计划存储在 admin_settings 中
- **AND** 系统在计划时间自动执行清理
- **AND** 即使应用关闭，清理也在后台运行
- **AND** 系统在审计日志中记录每次自动清理和计划信息

#### Scenario: 管理员查看清理历史
- **GIVEN** 管理员想回顾过去的清理操作
- **WHEN** 管理员导航到数据管理 → 清理历史
- **THEN** 系统显示所有清理操作列表（手动和自动）
- **AND** 每个条目显示日期、类型、删除的项目计数、由谁发起（管理员名称或"自动"）
- **AND** 管理员可以按日期范围或操作类型过滤
- **AND** 管理员可以查看任何操作的详细清理报告

### Requirement: 数据验证
The system MUST be able to
系统必须在维护操作前后验证数据完整性和一致性。

#### Scenario: 管理员运行数据完整性检查
- **GIVEN** 管理员在排除数据问题
- **WHEN** 管理员点击"验证数据完整性"
- **THEN** 系统检查：
  - 孤立记录（无用户/作业的提交）
  - 缺失的外键关系
  - 重复条目
  - 无效的数据格式
- **AND** 系统显示验证报告
- **AND** 系统提供自动修复常见问题的选项
- **AND** 系统在审计日志中记录验证

#### Scenario: 系统发现数据不一致
- **GIVEN** 数据完整性检查正在运行
- **WHEN** 系统发现孤立的提交
- **THEN** 系统显示发现的问题列表
- **AND** 管理员可以选择删除孤立记录
- **AND** 系统在审计日志中记录每个修复操作
- **AND** 验证报告保存以供审计
