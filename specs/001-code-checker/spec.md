# Python代码查重助手 (CodeChecker) Android应用

**Feature Branch**: `001-code-checker`
**Created**: 2025-11-27
**Status**: Draft
**Input**: 开发 CodeChecker，一个面向北航程序设计课程的 Python 代码查重 Android 应用。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 学生注册登录并查看作业 (Priority: P1)

学生能够创建账户、登录系统，并浏览教师发布的作业列表。这是一个独立可测试的完整流程，为学生用户提供基础功能入口。

**为什么此优先级**：这是所有学生功能的前提，学生必须先注册登录才能使用任何功能。没有此流程，应用对学生毫无价值。

**独立测试**：可以通过以下步骤完全验证：学生完成注册 → 登录 → 查看作业列表 → 退出登录。即使只实现此用户故事，仍能为学生提供基本价值（查看作业）。

**Acceptance Scenarios**:

1. **Given** 学生未注册, **When** 学生输入有效用户名、密码、显示名称并选择学生角色注册, **Then** 系统显示注册成功并跳转至登录页面
2. **Given** 学生已注册, **When** 学生输入正确用户名密码登录, **Then** 系统显示登录成功并跳转至作业列表页面
3. **Given** 学生已登录, **When** 学生查看作业列表, **Then** 系统显示所有可用作业的标题、描述和截止日期
4. **Given** 学生已登录, **When** 学生点击某个作业, **Then** 系统显示作业详情包括描述和提交要求
5. **Given** 学生已登录, **When** 学生选择退出登录, **Then** 系统清除登录状态并跳转至登录页面

---

### User Story 2 - 学生提交Python代码 (Priority: P1)

学生能够选择并提交Python代码文件到指定作业，支持多文件提交，查看提交历史。这是学生核心业务流程的第二步。

**为什么此优先级**：这是学生的主要功能，直接实现业务价值。没有代码提交，查重功能无法进行。

**独立测试**：可通过：学生登录 → 选择作业 → 选择多个.py文件 → 确认提交 → 查看提交历史记录进行完整验证。

**Acceptance Scenarios**:

1. **Given** 学生已登录并选择作业, **When** 学生选择单个.py文件并提交, **Then** 系统显示提交成功并记录提交时间
2. **Given** 学生已登录并选择作业, **When** 学生选择多个.py文件并提交, **Then** 系统显示所有文件提交成功并逐一记录
3. **Given** 学生选择已提交的文件, **When** 学生重新选择同一文件提交, **Then** 系统提示文件已存在并允许覆盖或跳过
4. **Given** 学生尝试提交非.py文件, **When** 学生选择.txt文件并提交, **Then** 系统拒绝提交并提示只能提交.py文件

---

### User Story 3 - 教师创建和管理作业 (Priority: P2)

教师能够创建作业任务，查看自己创建的所有作业，以及查看作业下的学生提交。这是教师功能的基础。

**为什么此优先级**：教师必须先创建作业，学生才能提交。没有此功能，应用无法支持教学场景。

**独立测试**：可验证：教师注册 → 创建作业 → 查看作业列表 → 查看作业提交 → 管理作业信息。

**Acceptance Scenarios**:

1. **Given** 教师未注册, **When** 教师输入有效信息并选择教师角色注册, **Then** 系统注册成功并允许教师访问管理功能
2. **Given** 教师已登录, **When** 教师创建作业并输入标题、描述、截止日期, **Then** 系统显示作业创建成功并保存到数据库
3. **Given** 教师已创建作业, **When** 教师查看自己的作业列表, **Then** 系统显示所有创建的作业及状态
4. **Given** 教师选择某个作业, **When** 教师查看该作业的所有学生提交, **Then** 系统显示提交学生姓名、文件名和提交时间
5. **Given** 教师查看作业, **When** 教师编辑作业信息, **Then** 系统更新作业信息并保存修改

---

### User Story 4 - 教师执行查重并查看报告 (Priority: P2)

教师能够对某个作业下的所有学生提交执行查重操作，查看历史报告，并在报告中查看相似度分布和高相似度警告列表。

**为什么此优先级**：这是应用的核心价值功能 - 代码相似度检测。没有此功能，应用失去存在意义。

**独立测试**：可通过：教师选择作业 → 执行查重 → 查看查重进度 → 查看报告详情进行完整验证。

**Acceptance Scenarios**:

1. **Given** 作业下有多个学生提交, **When** 教师点击"开始查重", **Then** 系统显示查重进度（当前/总数）并开始比对
2. **Given** 查重正在执行, **When** 教师等待查重完成, **Then** 系统显示查重完成并生成查重报告
3. **Given** 查重报告已生成, **When** 教师查看报告详情, **Then** 系统显示相似度分布图表和警告列表
4. **Given** 查重报告已生成, **When** 教师查看完整比对结果, **Then** 系统显示所有提交对的相似度得分并支持按相似度排序
5. **Given** 存在高相似度代码对（>60%）, **When** 教师查看报告, **Then** 系统突出显示高相似度警告列表

---

### User Story 5 - 查看代码高亮对比 (Priority: P3)

教师和学生能够查看两份代码的高亮对比视图，识别相似的代码段。这是查重结果的直观展示。

**为什么此优先级**：提供查重结果的详细分析，增强用户体验，但不如核心功能重要。

**独立测试**：可验证：从报告选择代码对 → 查看对比界面 → 识别高亮标记的相似区域。

**Acceptance Scenarios**:

1. **Given** 查重报告已生成, **When** 教师选择某个代码对查看对比, **Then** 系统以左右分栏显示两份代码
2. **Given** 代码对比视图已打开, **When** 系统显示相似代码段, **Then** 系统用高亮标记相似区域并显示相似度百分比
3. **Given** 代码对比视图已打开, **When** 教师查看代码信息, **Then** 系统显示提交者姓名、文件名和相似度百分比
4. **Given** 学生查看与自己相关的对比, **When** 学生选择某对代码查看, **Then** 系统仅显示学生可见的对比结果（符合权限控制）
5. **Given** 代码很长需要滚动, **When** 教师在对比视图中滚动, **Then** 系统保持同步滚动以便对齐查看

---

### User Story 6 - AI智能分析（选做功能）(Priority: P3)

教师能够对高相似度代码对调用AI进行智能分析，获取相似原因和抄袭风险等级。系统支持多个AI服务提供商（DeepSeek、阿里通义千问、ModelScope等），用户可在设置中配置自己的API和模型。这是增值功能，提供更深入的分析。

**为什么此优先级**：提供增值服务，提升分析准确性，但不是核心功能。有助于教师做出更准确的判断。多提供商支持允许用户根据需求和预算灵活选择。

**Independent Test**：可选功能，不影响主要流程。可通过：选择高相似度代码对 → 选择AI提供商 → 调用AI分析 → 查看分析报告验证。

**Acceptance Scenarios**:

1. **Given** 存在高相似度代码对（>60%）, **When** 教师选择AI分析并选择提供商, **Then** 系统调用相应AI API并显示分析进度
2. **Given** AI分析完成, **When** 教师查看分析结果, **Then** 系统显示相似原因（逻辑相同、变量重命名、代码复制等）
3. **Given** AI分析完成, **When** 教师查看风险评估, **Then** 系统显示抄袭风险等级（低/中/高）
4. **Given** AI API调用失败, **When** 系统检测到API错误, **Then** 系统降级显示基础分析结果并提示用户检查API配置
5. **Given** 用户首次使用AI分析, **When** 用户进入AI设置页面, **Then** 系统显示支持的AI提供商列表供用户选择和配置

---

### Edge Cases

- **用户尝试重复注册**：系统应检测并提示用户名已存在
- **空作业列表**：新注册学生应看到空状态提示和信息引导
- **学生尝试访问非自己提交**：系统应阻止访问并提示权限不足
- **查重过程中应用被关闭**：重新打开后应恢复查重进度
- **代码文件无法解析**：系统应提示文件格式错误并跳过该文件
- **网络连接中断（如果集成AI）**：系统应提示离线模式并提供基础功能
- **极大量提交（>100份）**：查重应分批处理并显示进度
- **截止日期已过**：学生应能看到作业但不能提交新代码
- **文件名包含特殊字符**：系统应正确处理并保存
- **代码文件为空**：系统应提示文件为空并跳过
- **极长代码行（>1000字符）**：系统应正确显示和处理
- **并发查重操作**：系统应排队处理并显示等待状态
- **数据存储已满**：系统应提示存储空间不足并建议清理
- **应用异常崩溃**：系统应保存用户数据并在重启时恢复

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持用户注册，包含用户名、密码、显示名称和角色选择（学生/教师）
- **FR-002**: 系统必须验证用户登录凭据并持久化登录状态，重启应用后保持登录
- **FR-003**: 系统必须支持用户登出并清除登录状态
- **FR-004**: 系统必须使用SHA-256加密存储用户密码，禁止明文存储
- **FR-005**: 教师必须能够创建作业，包含标题（必填）、描述（可选）、截止日期（可选）、提交上限配置（必选：小型200份/大型500份/无限制）、Python版本配置（必选：Python 2.x/Python 3.x/二者兼容）

#### Python版本配置说明

Python版本配置影响Token化过程：
- **Python 2.x**: 保留`print`语句语法（无括号）、`unicode`字符串标识等
- **Python 3.x**: 识别`print()`函数调用、`nonlocal`关键字等
- **二者兼容**: 智能识别两种语法，不将版本特定语法纳入相似度计算

**算法影响**: Token化阶段会过滤版本特定关键字，仅保留通用Python语法进行相似度计算。

- **FR-006**: 教师必须能够查看自己创建的所有作业列表和详细信息
- **FR-007**: 教师必须能够查看指定作业下的所有学生提交记录（学生姓名、文件名、提交时间）
- **FR-008**: 学生必须能够查看所有可用的作业列表和详情
- **FR-009**: 学生必须能够查看自己的提交历史记录，包括文件名、提交时间和作业名称。详细验收标准请参考User Story 2验收场景3。
- **FR-010**: 系统必须自动记录提交时间、文件名并计算代码MD5用于快速判重
- **FR-012**: 系统必须实现Python词法分析器，提取Token序列（关键字、标识符、运算符、数字、字符串、分隔符）
- **FR-013**: 系统必须移除注释和空白行后可选择标准化变量名（将标识符替换为统一占位符）

### 标准化配置说明

- **默认行为**: 标识符标准化默认启用，用于提高查重准确性
- **UI配置位置**: 查重设置页面（教师）或全局设置中
- **算法影响**: 启用时，所有标识符（如变量名、函数名）替换为统一占位符（`VAR_1`, `FUNC_1`等），仅保留代码结构相似性
- **存储策略**: 系统同时存储原始代码（用于高亮显示）和标准化代码（用于算法计算）

- **FR-014**: 系统必须实现Jaccard相似度计算（基于Token集合交并比）和LCS相似度计算（最长公共子序列比例）
- **FR-015**: 系统必须计算加权综合相似度得分（0.4 * Jaccard + 0.6 * LCS）
- **FR-016**: 系统必须实现两两比对引擎，对作业下所有提交进行比对并输出相似度得分
- **FR-017**: 系统必须在查重过程中显示实时进度（当前/总数），进度更新频率为每完成1对比较或每5%，以较大者为准，显示为整数百分比
- **FR-018**: 系统必须识别并标记匹配区域用于高亮显示
- **FR-019**: 系统必须支持学生角色权限控制，学生只能查看与自己相关的查重结果
- **FR-020**: 系统必须显示历史查重报告列表
- **FR-021**: 系统必须显示报告详情，包含相似度分布图表和完整比对结果列表
- **FR-022**: 系统必须高亮显示高相似度警告（阈值：60%）并支持按相似度排序
- **FR-023**: 系统必须提供代码对比界面，以左右分栏显示两份代码并标记相似区域
- **FR-024**: 系统必须在UI操作中提供明确的成功/失败反馈
- **FR-025**: 系统必须在查重计算过程中显示实时进度条
- **FR-026**: 系统必须支持系统字体缩放和主题切换（深色/浅色模式）
- **FR-027**: 系统必须在关键操作前显示确认对话框（删除、开始查重）
- **FR-028**: 系统必须将所有数据存储在本地SQLite数据库
- **FR-029**: 系统必须支持Android 9.0 (API 28)及以上版本
- **FR-030**: 系统必须遵循Material Design 3设计规范
- **FR-031**: 系统必须实现基本日志记录，记录用户操作、查重结果和错误信息
- **FR-032**: 系统必须管理作业和提交的状态转换：作业（草稿→进行中→已截止），提交（已提交→已查重→已分析）
- **FR-033**: 系统必须支持并发查重操作的队列管理，所有查重请求排队执行并显示等待状态
- **FR-034**: 系统必须支持用户主动删除自己的数据和自动数据清理机制（固定期限后自动删除）

### Key Entities

- **用户（User）**：系统中的注册用户，包含用户名（全局唯一）、密码哈希、显示名称、角色（学生/教师）、创建时间等属性
- **作业（Assignment）**：教师创建的学习任务，包含标题、描述、截止日期、创建者（教师）、创建时间、提交上限配置（小型200份/大型500份/无限制）、Python版本配置（Python 2.x/Python 3.x/二者兼容）、状态（草稿/进行中/已截止）等属性
- **提交（Submission）**：学生向作业提交的代码文件，包含关联的学生ID、作业ID、文件名、代码内容、MD5、提交时间、状态（已提交/已查重/已分析）等属性
- **查重报告（Report）**：某次查重操作的结果，包含关联的作业ID、执行时间、状态、生成者等属性
- **相似度记录（SimilarityRecord）**：代码对之间的相似度数据，包含两个提交ID、综合相似度、Jaccard得分、LCS得分、匹配区域等属性
- **可选功能**：AI分析结果（AIAnalysis） - 计划在Phase 8实现，当前版本暂不包含，包含关联的相似度记录ID、分析类型、相似原因、风险等级、分析时间等属性

### 命名约定

为避免混淆，本项目采用以下命名约定：
- **数据库表**: snake_case（如`similarity_pairs`）
- **Kotlin类**: PascalCase（如`SimilarityEntity`）
- **领域模型**: PascalCase（如`Similarity`）
- **API响应**: camelCase（如`similarityScore`）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 学生能够成功注册并登录，平均操作时间不超过30秒（从启动应用到进入作业列表）
- **SC-002**: UI操作响应时间小于100ms（点击按钮、列表滚动、页面切换等交互）
- **SC-003**: 100份代码（每份200行）的查重任务在30秒内完成并生成报告
- **SC-004**: 学生在5分钟内完成代码提交流程（选择文件到提交成功）
- **SC-005**: 学生在3次点击内能够查看到自己的提交历史
- **SC-006**: 教师能够在2分钟内完成作业创建（填写信息到保存成功）
- **SC-007**: 查重报告生成后，教师能够在30秒内查看到相似度分布图表和警告列表
- **SC-008**: 代码对比视图加载时间小于2秒，支持流畅滚动查看
- **SC-009**: 应用冷启动时间小于3秒（从图标点击到显示登录页面）
- **SC-010**: 算法模块单元测试覆盖率大于80%
- **SC-011**: 系统能够正确处理边界情况：空文件、超大文件、特殊字符、异常文件格式等
- **SC-012**: 学生角色权限控制严格生效，学生无法访问其他学生的提交记录
- **SC-013**: 所有用户操作都有明确的成功/失败反馈，错误率低于5%
- **SC-014**: 支持的系统字体缩放（100%-200%）下界面布局正常，无遮挡或溢出
- **SC-015**: 核心功能（查重）支持离线使用，网络不可用时仍能进行本地查重

## Assumptions

- 用户已熟悉基本的Android操作
- 学生提交的Python代码文件是有效的.py格式，支持Python 2.x/3.x多种版本和编码
- 教师和学生账户信息真实有效
- 查重算法采用业界标准的Token化方法
- 应用主要在校园WiFi环境下使用
- 学生和教师使用同一设备（不是共享设备）
- 代码文件大小不超过1MB（单文件）
- 单一作业下学生提交数量不超过200份
- AI分析功能作为可选增值服务，计划在Phase 8实现，当前版本不包含
- 用户数据仅存储在本地，不涉及云端同步
- 数据保留期限由学校政策决定（默认1年），逾期自动删除
- 用户可在保留期内主动删除自己的数据

## Clarifications

### Session 2025-11-27

- **Q: AI智能分析功能是否纳入本次开发范围？** → **A: 延后至Phase 8** - 考虑到核心查重功能的复杂性，AI分析作为Phase 8的增值功能实现，不影响MVP交付。当前版本不包含AI相关代码和依赖。

- **Q: 用户名在整个系统中是否必须全局唯一？** → **A: 是** - 用户名在整个系统中必须全局唯一，每个用户名对应一个账户
- **Q: AI分析服务提供商选择？** → **A: 未来功能，当前版本不包含** - 计划在Phase 8实现时，支持DeepSeek、阿里通义千问、ModelScope等多个AI服务提供商，用户可在设置中配置自己的API和模型
- **Q: 应用是否需要支持多语言？** → **A: 否 - 仅支持中文** - 应用仅支持中文界面，降低开发复杂度
- **Q: 数据持久化与备份策略？** → **A: 不需要导出功能** - 应用不提供数据导出/导入功能，用户自行负责数据安全
- **Q: 作业提交数量上限？** → **A: 按作业规模配置** - 支持三种配置：小型作业（200份）、大型作业（500份）、无限制作业（不设置上限），教师创建作业时可选择
- **Q: 系统可靠性与恢复期望？** → **A: 标准可靠性（95%可用性）** - 适合轻量级教育应用，允许偶发故障但需保证数据不丢失
- **Q: 日志记录与监控信号？** → **A: 需要基本日志记录** - 记录用户操作、查重结果、错误信息，便于问题诊断和审计
- **Q: 作业与提交的生命周期状态？** → **A: 需要明确主要状态** - 定义作业和提交的核心状态：作业（草稿/进行中/已截止），提交（已提交/已查重/已分析）
- **Q: 并发查重操作的冲突解决？** → **A: 队列处理** - 所有查重请求排队，先来先服务，避免资源冲突和重复计算
- **Q: 数据保留与删除政策？** → **A: 固定期限自动删除+用户可手动删除** - 数据在固定期限后自动删除，期间用户可主动删除自己的数据
- **Q: Python代码文件格式与编码规范？** → **A: 多版本支持可配置** - 支持Python 2.x、3.x和多种编码，教师发布作业时可选择代码版本（Python 2.x、Python 3.x或二者兼容）

## UI Wireframes Description

### 登录/注册页面
- **布局**：居中卡片式设计，包含应用Logo和标题"CodeChecker"
- **登录表单**：用户名输入框、密码输入框、登录按钮、注册链接
- **注册表单**：用户名、密码、确认密码、显示名称、单选按钮（学生/教师）、注册按钮
- **底部**：版本号和版权信息
- **主题**：支持深色/浅色模式切换

### 首页（作业列表）
- **顶部**：应用标题栏，显示用户角色和登出按钮
- **内容区**：
  - 学生视图：作业列表卡片，每个卡片显示标题、描述、截止日期、状态（可提交/已截止）
  - 教师视图：作业管理卡片，包含创建作业按钮、我的作业列表、查看提交按钮
- **底部**：浮动操作按钮（FAB）用于创建作业（教师）
- **空状态**：暂无作业时显示提示信息和引导

### 代码提交页面
- **顶部**：返回按钮、作业标题、提交状态
- **选择区**：文件选择器按钮，显示已选择的文件列表
- **文件列表**：每个文件项显示文件名、大小、状态（已选择/已提交）
- **底部**：提交按钮（禁用状态当无文件选择时）
- **进度**：文件上传进度条

### 查重报告列表
- **顶部**：报告筛选器（按作业筛选）、刷新按钮
- **列表项**：每个报告显示作业名称、生成时间、提交数量、高相似度对数量、状态（完成/进行中）
- **空状态**：暂无报告时显示提示
- **操作**：点击查看详情、长按删除

### 报告详情页
- **顶部**：报告概要信息卡片（作业名称、时间、总数）
- **图表区**：相似度分布柱状图（0-20%, 20-40%, 40-60%, 60-80%, 80-100%）
- **警告区**：红色警告列表显示高相似度对（>60%）
- **完整列表**：所有代码对列表，可按相似度排序，包含学生姓名对、文件名、相似度百分比
- **操作**：点击查看代码对比

### 代码对比页
- **顶部**：对比概览（学生A vs 学生B，相似度百分比）
- **对比区**：左右分栏代码视图，相同行用相同颜色高亮标记
- **辅助信息**：行号、提交者信息、文件名
- **滚动**：左右同步滚动，滚动条指示当前位置
- **导航**：上一对/下一对按钮快速切换
